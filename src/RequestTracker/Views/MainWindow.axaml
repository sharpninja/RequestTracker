<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:RequestTracker.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:models="using:RequestTracker.Models"
        xmlns:jsonModels="using:RequestTracker.Models.Json"
        xmlns:conv="using:RequestTracker.Converters"
        xmlns:views="using:RequestTracker.Views"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="RequestTracker.Views.MainWindow"
        x:Name="Root"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="RequestTracker"
        Width="1000" Height="700"
        WindowStartupLocation="CenterScreen"
        WindowState="Normal"
        ShowInTaskbar="True">

    <Window.Resources>
        <conv:PathToWslConverter x:Key="PathToWsl"/>
        <conv:EqualityToBrushConverter x:Key="EqualityToBrush"/>
        <conv:EmptyStringToAllConverter x:Key="EmptyStringToAll"/>
    </Window.Resources>

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid x:Name="MainGrid" ColumnDefinitions="300, 4, *" RowDefinitions="*, 4, 150">
        <!-- Tree View -->
        <TreeView x:Name="TreePanel" Grid.Column="0" Grid.Row="0" ItemsSource="{Binding Nodes}" SelectedItem="{Binding SelectedNode}">
            <TreeView.ItemTemplate>
                <TreeDataTemplate ItemsSource="{Binding Children}" DataType="models:FileNode">
                    <TextBlock Text="{Binding Name}"/>
                </TreeDataTemplate>
            </TreeView.ItemTemplate>
            <TreeView.ItemContainerTheme>
                <ControlTheme TargetType="TreeViewItem" BasedOn="{StaticResource {x:Type TreeViewItem}}" x:DataType="models:FileNode">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                </ControlTheme>
            </TreeView.ItemContainerTheme>
        </TreeView>

        <!-- Splitter 1 (Vertical separator in Left Pane for Landscape / Top separator in Portrait) -->
        <GridSplitter x:Name="Splitter1" Grid.Column="0" Grid.Row="1" ResizeDirection="Rows" Background="LightGray"/>

        <!-- History Panel -->
        <Border x:Name="HistoryPanel" Grid.Column="0" Grid.Row="2" BorderBrush="Gray" BorderThickness="0,1,0,0">
            <ListBox ItemsSource="{Binding ChangeLog}" Background="#f8f8f8"/>
        </Border>

        <!-- Splitter 2 (Horizontal separator between Panes in Landscape / Bottom separator in Portrait) -->
        <GridSplitter x:Name="Splitter2" Grid.Column="1" Grid.Row="0" Grid.RowSpan="3" ResizeDirection="Columns" Background="LightGray"/>

        <!-- Viewer Panel -->
        <Grid x:Name="ViewerPanel" Grid.Column="2" Grid.Row="0" Grid.RowSpan="3" RowDefinitions="Auto, *, Auto">
             <!-- Navigation Toolbar -->
             <Grid Grid.Row="0" ColumnDefinitions="Auto, Auto, Auto, Auto, Auto, Auto, *" Margin="5">
                <Button Grid.Column="0" Command="{Binding NavigateBackCommand}" Margin="0,0,5,0" Width="30" ToolTip.Tip="Back">
                    <PathIcon Data="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" Width="10" Height="10"/>
                </Button>
                <Button Grid.Column="1" Command="{Binding NavigateForwardCommand}" Margin="0,0,5,0" Width="30" ToolTip.Tip="Forward">
                    <PathIcon Data="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" Width="10" Height="10"/>
                </Button>
                <Button Grid.Column="2" Command="{Binding RefreshCommand}" Margin="0,0,5,0" Width="30" ToolTip.Tip="Refresh">
                    <PathIcon Data="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" Width="10" Height="10"/>
                </Button>
                <Button Grid.Column="3" Command="{Binding OpenAgentConfigCommand}" Margin="0,0,5,0" ToolTip.Tip="Open agent config in default editor">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" Width="14" Height="14"/>
                        <TextBlock Text="Agent config" VerticalAlignment="Center" FontSize="12"/>
                    </StackPanel>
                </Button>
                <Button Grid.Column="4" Command="{Binding OpenPromptTemplatesCommand}" Margin="0,0,5,0" ToolTip.Tip="Open prompt templates in default editor">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" Width="14" Height="14"/>
                        <TextBlock Text="Prompts" VerticalAlignment="Center" FontSize="12"/>
                    </StackPanel>
                </Button>
                <Button Grid.Column="5" Click="OpenChatWindow" Margin="0,0,5,0" ToolTip.Tip="AI Assistant">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="M12,2C6.48,2 2,6.48 2,12s4.48,10 10,10 10,-4.48 10,-10S17.52,2 12,2zM12,20c-4.41,0 -8,-3.59 -8,-8s3.59,-8 8,-8 8,3.59 8,8 -3.59,8 -8,8zM12.5,7H11v6l5.25,3.15 0.75,-1.23 -4.5,-2.67z" Width="14" Height="14"/>
                        <TextBlock Text="AI" VerticalAlignment="Center" FontSize="12"/>
                    </StackPanel>
                </Button>
                <TextBox Grid.Column="6" Text="{Binding SelectedNodePathDisplay, Mode=OneWay, Converter={StaticResource PathToWsl}}" IsReadOnly="True" VerticalContentAlignment="Center"/>
             </Grid>

             <!-- Markdown View (raw markdown only) -->
             <Border Grid.Row="1" BorderBrush="Gray" BorderThickness="1" Margin="5" Background="White" IsVisible="{Binding IsMarkdownVisible}">
                <Grid x:Name="MarkdownContentGrid" RowDefinitions="Auto, *">
                    <TextBlock Grid.Row="0" Text="Loading…" IsVisible="{Binding ShowMarkdownLoadingPlaceholder}"
                               VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="Gray" Margin="12"/>
                    <Border Grid.Row="1" IsVisible="{Binding IsPreviewOpenedInBrowser}" Background="White" Padding="0">
                        <Grid RowDefinitions="Auto, *">
                            <Border Grid.Row="0" Background="#f0f0f0" Padding="8,6" BorderBrush="#ddd" BorderThickness="0,0,0,1">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <Button Content="Open HTML preview in browser" Command="{Binding OpenPreviewInBrowserCommand}"/>
                                    <Button Content="Archive" Command="{Binding ArchiveCommand}"/>
                                </StackPanel>
                            </Border>
                            <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                <SelectableTextBlock Text="{Binding CurrentPreviewMarkdownText}"
                                                     TextWrapping="Wrap"
                                                     FontFamily="Consolas, monospace"
                                                     FontSize="15"
                                                     Padding="12"
                                                     Foreground="Black"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>
             </Border>

             <!-- JSON Tree View with Summary and Search -->
             <Border Grid.Row="1" BorderBrush="Gray" BorderThickness="1" Margin="5" Background="White" IsVisible="{Binding IsJsonVisible}">
                <Grid x:Name="JsonViewerGrid" RowDefinitions="Auto, Auto, 2*, 4, *">
                    <!-- Summary -->
                    <Border Grid.Row="0" Background="#f0f0f0" Padding="8" Margin="0,0,0,4">
                        <ItemsControl ItemsSource="{Binding JsonLogSummary.SummaryLines}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}" FontSize="14" Margin="0,1"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>
                    <!-- Search -->
                    <Grid Grid.Row="1" ColumnDefinitions="Auto, *" Margin="0,0,0,4">
                        <TextBlock Grid.Column="0" Text="Search:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <TextBox Grid.Column="1" Text="{Binding SearchQuery}" Watermark="Request ID, text, model, timestamp..."/>
                    </Grid>
                    <!-- Search results index -->
                    <Border Grid.Row="2" MinHeight="80" BorderBrush="#ddd" BorderThickness="0,0,0,1" Padding="4" Margin="0,0,0,4">
                        <Grid RowDefinitions="Auto, Auto, *">
                            <TextBlock Grid.Row="0" Text="Search index (double-click to open request)" FontWeight="SemiBold" FontSize="13" Margin="0,0,0,4"/>
                            <Border Grid.Row="1" Background="#E8E8E8" BorderBrush="#C0C0C0" BorderThickness="0,0,0,1" Padding="0" Margin="0,0,0,0">
                                <Grid RowDefinitions="Auto, Auto" ColumnDefinitions="250,*,100,100,130" Margin="4,2">
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Request ID" FontWeight="SemiBold" FontSize="13" FontFamily="Consolas, Monospace" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="Display" FontWeight="SemiBold" FontSize="13" FontFamily="Consolas, Monospace" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBlock Grid.Row="0" Grid.Column="2" Text="Model" FontWeight="SemiBold" FontSize="13" FontFamily="Consolas, Monospace" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBlock Grid.Row="0" Grid.Column="3" Text="Agent" FontWeight="SemiBold" FontSize="13" FontFamily="Consolas, Monospace" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBlock Grid.Row="0" Grid.Column="4" Text="Timestamp" FontWeight="SemiBold" FontSize="13" FontFamily="Consolas, Monospace" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Row="1" Grid.Column="0" ItemsSource="{Binding DistinctRequestIds}" SelectedItem="{Binding RequestIdFilter}" FontSize="12" FontFamily="Consolas, Monospace" Margin="0,2,8,0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EmptyStringToAll}}" FontFamily="Consolas, Monospace" TextTrimming="CharacterEllipsis"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <ComboBox Grid.Row="1" Grid.Column="1" ItemsSource="{Binding DistinctDisplayTexts}" SelectedItem="{Binding DisplayFilter}" FontSize="12" FontFamily="Consolas, Monospace" Margin="0,2,8,0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EmptyStringToAll}}" FontFamily="Consolas, Monospace" TextTrimming="CharacterEllipsis" TextWrapping="NoWrap" MaxWidth="400"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <ComboBox Grid.Row="1" Grid.Column="2" ItemsSource="{Binding DistinctModels}" SelectedItem="{Binding ModelFilter}" FontSize="12" FontFamily="Consolas, Monospace" Margin="0,2,8,0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EmptyStringToAll}}" FontFamily="Consolas, Monospace" TextTrimming="CharacterEllipsis"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <ComboBox Grid.Row="1" Grid.Column="3" ItemsSource="{Binding DistinctAgents}" SelectedItem="{Binding AgentFilter}" FontSize="12" FontFamily="Consolas, Monospace" Margin="0,2,8,0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EmptyStringToAll}}" FontFamily="Consolas, Monospace" TextTrimming="CharacterEllipsis"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <ComboBox Grid.Row="1" Grid.Column="4" ItemsSource="{Binding DistinctTimestamps}" SelectedItem="{Binding TimestampFilter}" FontSize="12" FontFamily="Consolas, Monospace" Margin="0,2,0,0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EmptyStringToAll}}" FontFamily="Consolas, Monospace" TextTrimming="CharacterEllipsis"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="2" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="SearchIndexList" ItemsSource="{Binding FilteredSearchEntries}" x:CompileBindings="False">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Spacing="0"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="jsonModels:SearchableEntry">
                                            <Border BorderBrush="#C0C0C0" BorderThickness="0,0,0,1"
                                                    Tapped="OnSearchRowTapped"
                                                    DoubleTapped="OnSearchRowDoubleTapped">
                                                <Border.Background>
                                                    <MultiBinding Converter="{StaticResource EqualityToBrush}">
                                                        <Binding Path="."/>
                                                        <Binding Path="DataContext.SelectedSearchEntry" ElementName="Root"/>
                                                    </MultiBinding>
                                                </Border.Background>
                                                <Grid ColumnDefinitions="250,*,100,100,130" Margin="4,2">
                                                    <SelectableTextBlock Grid.Column="0" Text="{Binding RequestId}" FontFamily="Consolas, Monospace" FontSize="13" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                                    <SelectableTextBlock Grid.Column="1" Text="{Binding DisplayText}" FontFamily="Consolas, Monospace" FontSize="13" TextWrapping="Wrap" VerticalAlignment="Top" Margin="0,0,8,0"/>
                                                    <SelectableTextBlock Grid.Column="2" Text="{Binding Model}" FontFamily="Consolas, Monospace" FontSize="13" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                                    <SelectableTextBlock Grid.Column="3" Text="{Binding Agent}" FontFamily="Consolas, Monospace" FontSize="13" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                                    <SelectableTextBlock Grid.Column="4" Text="{Binding TimestampDisplay}" FontFamily="Consolas, Monospace" FontSize="13" TextTrimming="CharacterEllipsis" VerticalAlignment="Center"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                    <!-- Splitter between search index and JSON tree -->
                    <GridSplitter Grid.Row="3" ResizeDirection="Rows" Background="LightGray" Height="4"/>
                    <!-- Tree -->
                    <TreeView Grid.Row="4" ItemsSource="{Binding JsonTree}" SelectedItem="{Binding SelectedJsonNode}">
                        <TreeView.ItemTemplate>
                            <TreeDataTemplate ItemsSource="{Binding Children}" DataType="jsonModels:JsonTreeNode">
                                <StackPanel Orientation="Horizontal" Spacing="5" Background="Transparent" DoubleTapped="OnJsonNodeDoubleTapped">
                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="#007acc"/>
                                    <TextBlock Text=":" Foreground="Gray"/>
                                    <TextBlock Text="{Binding Value}" Foreground="#ce9178"/>
                                    <TextBlock Text="{Binding Type}" Foreground="Gray" FontStyle="Italic" FontSize="12" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                </StackPanel>
                            </TreeDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </Grid>
             </Border>

             <!-- Request Details View -->
             <Border Grid.Row="1" BorderBrush="Gray" BorderThickness="1" Margin="5" Background="White" IsVisible="{Binding IsRequestDetailsVisible}">
                <Grid RowDefinitions="Auto, *">
                    <Grid Grid.Row="0" ColumnDefinitions="Auto, Auto, Auto, *" Margin="5" VerticalAlignment="Center">
                        <Button Grid.Column="0" Content="← Back to List" Command="{Binding CloseRequestDetailsCommand}" Margin="0,0,10,0"/>
                        <Button Grid.Column="1" Content="← Previous" Command="{Binding NavigateToPreviousRequestCommand}" Margin="0,0,10,0"/>
                        <Button Grid.Column="2" Content="Next →" Command="{Binding NavigateToNextRequestCommand}" Margin="0,0,10,0"/>
                    </Grid>
                    <views:RequestDetailsView Grid.Row="1" DataContext="{Binding SelectedUnifiedRequest}"/>
                </Grid>
             </Border>

             <!-- Status Bar -->
             <Border Grid.Row="2" Background="#007acc" Padding="5">
                 <SelectableTextBlock Text="{Binding StatusMessage}" Foreground="White" FontWeight="Bold"/>
             </Border>
        </Grid>
    </Grid>

</Window>
